{"captainVersion":4,"caproverOneClickApp":{"displayName":"Frappe and/or ERPNext","isOfficial":true,"description":"Frappe and/or ERPNext installation","documentation":"Nothing to say right now","variables":[{"id":"$$cap_USER_EMAIL","label":"Your User Email"},{"id":"$$cap_USER_PASSWORD","label":"Your User Password","defaultValue":"$$cap_gen_random_hex(16)"},{"id":"$$cap_ADMINISTRATOR_PASSWORD","label":"Tenant Administrator Password","defaultValue":"$$cap_gen_random_hex(16)"},{"id":"$$cap_APP_TYPE","label":"Installation Type","description":"(frappe|erpnext)","defaultValue":"erpnext","validRegex":"/^(frappe|erpnext)$/"},{"id":"$$cap_APP_VERSION","label":"Installation Version","description":"Frappe / ERPNext version (eg: version-15)","defaultValue":"v15"},{"id":"$$cap_DB_HOST","label":"Mariadb Host","defaultValue":"srv-captain--$$cap_appname-db"},{"id":"$$cap_DB_PORT","label":"Mariadb Port","defaultValue":"3306"},{"id":"$$cap_DB_ROOT_USER","label":"Mariadb ROOT User","defaultValue":"root"},{"id":"$$cap_DB_ROOT_PASSWORD","label":"Mariadb ROOT Password","defaultValue":"$$cap_gen_random_hex(16)"},{"id":"$$cap_SOCKETIO_PORT","label":"Socketio PORT","defaultValue":"9000","validRegex":"/^([0-9]+)/"},{"id":"$$cap_BACKEND_PORT","label":"Backend PORT","defaultValue":"8000","validRegex":"/^([0-9]+)/"},{"id":"$$cap_UPSTREAM_REAL_IP_ADDRESS","label":"Nginx Upstream Real IP Address","defaultValue":"127.0.0.1","description":"Usually, it's the public IP of your server"},{"id":"$$cap_UPSTREAM_REAL_IP_HEADER","label":"Nginx Upstream Real IP Header","defaultValue":"X-Forwarded-For"},{"id":"$$cap_UPSTREAM_IP_RECURSIVE","label":"Nginx Upstream IP Recursive","defaultValue":"true"},{"id":"$$cap_PROXY_READ_TIMEOUT","label":"Nginx Proxy Read Timeout","defaultValue":"120"},{"id":"$$cap_CLIENT_MAX_BODY_SIZE","label":"Nginx Client Max Body Size","defaultValue":"50m"}],"instructions":{"start":"This is a all-in-one Captain Template and will deploy all services \nneeded for ERPNext or Frappe execution environment.\n\nIn total this template will launch 12 containers\n\n2 Redis Instances             - OK if Running\n1 Mariadb Instance            - OK if Running\n1 Backend Service             - OK if Running\n1 Frontend Service            - OK if Running\n2 Worker Services             - OK if Running\n1 Scheduler Service           - OK if Running\n1 Socketio Service            - OK if Running\n\n1 Configurator Container      - OK if DEAD\n1 Site Creator                - OK if DEAD","end":"We launched 12 containers, to launch ERPNext/Frappe\n\nYour ERPNext should be accessible at http://$$cap_appname.$$cap_root_domain\n\nCredentials:\n| Role       | Username                     | Password | \n+------------+------------------------------+----------|\n|Admin       | Administrator                | $$cap_ADMINISTRATOR_PASSWORD |\n|Sys Manager | $$cap_USER_EMAIL             | $$cap_USER_PASSWORD  |\n\nYou should allways keep those services running \nto maintain the healthy of ERPNext/Frappe Services\n\n| Service          |Purpose             |Internal Host |\n+------------------+--------------------+--------------+\n| Redis            | Cache              | srv-captain--$$cap_appname-redis-cache |\n| Redis            | Background Queue   | srv-captain--$$cap_appname-redis-queue |\n| Mariadb          | Database           | srv-captain--$$cap_appname-db          |\n| Backend          | Application        | srv-captain--$$cap_appname-backend     |\n| Frontend         | Nginx Proxy        | srv-captain--$$cap_appname-frontend    |\n| Socketio         | WebSocket          | srv-captain--$$cap_appname-websocket   |\n| Worker           | Background Consumer| srv-captain--$$cap_appname-queue-short |\n| Worker           | Background Consumer| srv-captain--$$cap_appname-queue-long  |\n| Scheduler        | Background Trigger | srv-captain--$$cap_appname-scheduler   |\n\nAdditionally to those services, we launched also 2 additional containers\nthat surelly can be deleted, they are\n\n| Service          |Purpose             |Internal Host |\n+------------------+--------------------+--------------+\n| Configurator     | Define Settings    | $$cap_appname-configurator |\n| Site-Creator     | Launch             | $$cap_appname-site-creator |"}},"x-customizable-image":{"image":"frappe/$$cap_APP_TYPE:$$cap_APP_VERSION"},"x-depends-on-configurator":{"depends_on":{"configurator":{"condition":"service_completed_successfully"}}},"x-sites-volume":{"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"]},"x-backend-defaults":{"depends_on":{"configurator":{"condition":"service_completed_successfully"}},"image":"frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"]},"x-redis-defaults":{"caproverExtra":{"notExposeAsWebApp":true},"image":"redis:6.2-alpine","deploy":{"restart_policy":{"condition":"on-failure"}}},"services":{"$$cap_appname-db":{"caproverExtra":{"notExposeAsWebApp":true},"image":"mariadb:10.6","volumes":["$$cap_appname-db-data:/var/lib/mysql"],"environment":{"MYSQL_ROOT_PASSWORD":"$$cap_DB_ROOT_PASSWORD"},"deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname-redis-queue":{"caproverExtra":{"notExposeAsWebApp":true},"image":"redis:6.2-alpine","deploy":{"restart_policy":{"condition":"on-failure"}},"volumes":["$$cap_appname-redis-queue-data:/data"]},"$$cap_appname-redis-cache":{"caproverExtra":{"notExposeAsWebApp":true},"image":"redis:6.2-alpine","deploy":{"restart_policy":{"condition":"on-failure"}},"volumes":["$$cap_appname-redis-cache-data:/data"]},"$$cap_appname-configurator":{"caproverExtra":{"notExposeAsWebApp":true,"dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","RUN apt-get update && apt-get install -y wait-for-it","# Create a multi-line startup.sh script during image build","RUN echo '#!/bin/bash' > startup.sh && cat >> startup.sh <<'EOF'","wait-for-it -t 30 $DB_HOST:$DB_PORT","wait-for-it -t 30 $REDIS_CACHE:6379","wait-for-it -t 30 $REDIS_QUEUE:6379","echo \"Starting configuration\";","mkdir -p sites","ls -1 apps > sites/apps.txt;","echo \"Apps Configured\";","bench set-config -g db_host $DB_HOST;","bench set-config -gp db_port $DB_PORT;","echo \"DB Host:Port set to $DB_HOST:$DB_PORT\";","bench set-config -g redis_cache \"redis://$REDIS_CACHE\";","echo \"Redis Queue set to $REDIS_CACHE\";","bench set-config -g redis_queue \"redis://$REDIS_QUEUE\";","echo \"Redis Cache set to $REDIS_CACHE\";","bench set-config -g redis_socketio \"redis://$REDIS_QUEUE\";","echo \"Redis Socketio set to $REDIS_QUEUE\";","bench set-config -gp socketio_port $SOCKETIO_PORT;","echo \"Socketio Port set to $SOCKETIO_PORT\";","echo \"Configuration complete\";","EOF","# Make the script executable","RUN chmod a+x startup.sh","CMD [\"startup.sh\"]"]},"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"platform":"linux/amd64","environment":{"DB_HOST":"$$cap_DB_HOST","DB_PORT":"$$cap_DB_PORT","DB_ROOT_USER":"$$cap_DB_ROOT_USER","DB_ROOT_PASSWORD":"$$cap_DB_ROOT_PASSWORD","REDIS_CACHE":"srv-captain--$$cap_appname-redis-cache:6379","REDIS_QUEUE":"srv-captain--$$cap_appname-redis-queue:6379","SOCKETIO_PORT":"$$cap_SOCKETIO_PORT"}},"$$cap_appname-backend":{"caproverExtra":{"notExposeAsWebApp":true},"depends_on":{"configurator":{"condition":"service_completed_successfully"}},"image":"frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"platform":"linux/amd64","deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname":{"caproverExtra":{"containerHttpPort":"$$cap_BACKEND_PORT","dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","# Create a multi-line startup.sh script during image build","RUN echo '#!/bin/bash' > startup.sh && cat >> startup.sh <<'EOF'","#!/bin/bash","","# Set variables that do not exist","if [[ -z \"\\$BACKEND\" ]]; then","   echo \"BACKEND defaulting to 0.0.0.0:8000\"","   export BACKEND=0.0.0.0:8000","fi","","if [[ -z \"\\$SOCKETIO\" ]]; then","  echo \"SOCKETIO defaulting to 0.0.0.0:9000\"","  export SOCKETIO=0.0.0.0:9000","fi","","if [[ -z \"\\$UPSTREAM_REAL_IP_ADDRESS\" ]]; then","  echo \"UPSTREAM_REAL_IP_ADDRESS defaulting to 127.0.0.1\"","  export UPSTREAM_REAL_IP_ADDRESS=127.0.0.1","fi","","if [[ -z \"\\$UPSTREAM_REAL_IP_HEADER\" ]]; then","  echo \"UPSTREAM_REAL_IP_HEADER defaulting to X-Forwarded-For\"","  export UPSTREAM_REAL_IP_HEADER=X-Forwarded-For","fi","","if [[ -z \"\\$UPSTREAM_REAL_IP_RECURSIVE\" ]]; then","  echo \"UPSTREAM_REAL_IP_RECURSIVE defaulting to off\"","  export UPSTREAM_REAL_IP_RECURSIVE=off","fi","","if [[ -z \"\\$FRAPPE_SITE_NAME_HEADER\" ]]; then","  # shellcheck disable=SC2016","  echo \"FRAPPE_SITE_NAME_HEADER defaulting to \\$host\"","  # shellcheck disable=SC2016","  export FRAPPE_SITE_NAME_HEADER=\\$host","fi","","if [[ -z \"\\$PROXY_READ_TIMEOUT\" ]]; then","  echo \"PROXY_READ_TIMEOUT defaulting to 120\"","  export PROXY_READ_TIMEOUT=120","fi","if [[ -z \"\\$CLIENT_MAX_BODY_SIZE\" ]]; then","  echo \"CLIENT_MAX_BODY_SIZE defaulting to 50m\"","  export CLIENT_MAX_BODY_SIZE=50m","fi","","# shellcheck disable=SC2016","envsubst '\\${BACKEND} \\${SOCKETIO} \\${UPSTREAM_REAL_IP_ADDRESS} \\${UPSTREAM_REAL_IP_HEADER} \\${UPSTREAM_REAL_IP_RECURSIVE} \\${FRAPPE_SITE_NAME_HEADER} \\${PROXY_READ_TIMEOUT} \\${CLIENT_MAX_BODY_SIZE}' </templates/nginx/frappe.conf.template >/etc/nginx/conf.d/frappe.conf","nginx -g 'daemon off;' ","EOF","# Make the script executable","RUN chmod a+x startup.sh","CMD [\"startup.sh\"]"]},"depends_on":["$$cap_appname-backend","$$cap_appname-websocket"],"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"environment":{"BACKEND":"srv-captain--$$cap_appname-backend:$$cap_BACKEND_PORT","SOCKETIO":"srv-captain--$$cap_appname-websocket:$$cap_SOCKETIO_PORT","FRAPPE_SITE_NAME_HEADER":"$$cap_appname.$$cap_root_domain","UPSTREAM_REAL_IP_ADDRESS":"$$cap_UPSTREAM_REAL_IP_ADDRESS","UPSTREAM_REAL_IP_HEADER":"$$cap_UPSTREAM_REAL_IP_HEADER","UPSTREAM_REAL_IP_RECURSIVE":"$$cap_UPSTREAM_IP_RECURSIVE","PROXY_READ_TIMEOUT":"$$cap_PROXY_READ_TIMEOUT","CLIENT_MAX_BODY_SIZE":"$$cap_CLIENT_MAX_BODY_SIZE"},"deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname-websocket":{"caproverExtra":{"notExposeAsWebApp":true,"dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","CMD [\"node\", \"/home/frappe/frappe-bench/apps/frappe/socketio.js\"]"]},"depends_on":{"configurator":{"condition":"service_completed_successfully"}},"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"environment":{"FRAPPE_SITE":"$$cap_appname.$$cap_root_domain","FRAPPE_REDIS_CACHE":"redis://srv-captain--$$cap_appname-redis-cache:6379","FRAPPE_REDIS_QUEUE":"redis://srv-captain--$$cap_appname-redis-queue:6379","FRAPPE_SOCKETIO_PORT":"$$cap_SOCKETIO_PORT"},"platform":"linux/amd64","deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname-queue-short":{"caproverExtra":{"notExposeAsWebApp":true,"dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","CMD [\"bench\", \"worker\", \"--queue\", \"short,default\"]"]},"depends_on":{"configurator":{"condition":"service_completed_successfully"}},"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname-queue-long":{"caproverExtra":{"notExposeAsWebApp":true,"dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","CMD [\"bench\", \"worker\", \"--queue\", \"long,default,short\"]"]},"depends_on":{"configurator":{"condition":"service_completed_successfully"}},"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname-scheduler":{"caproverExtra":{"notExposeAsWebApp":true,"dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","CMD [\"bench\", \"scheduler\"]"]},"platform":"linux/amd64","depends_on":{"configurator":{"condition":"service_completed_successfully"}},"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"deploy":{"restart_policy":{"condition":"on-failure"}}},"$$cap_appname-site-creator":{"caproverExtra":{"notExposeAsWebApp":true,"dockerfileLines":["FROM frappe/$$cap_APP_TYPE:$$cap_APP_VERSION","RUN apt-get update && apt-get install -y wait-for-it","# Create a multi-line startup.sh script during image build","RUN echo '#!/bin/bash' > startup.sh && cat >> startup.sh <<'EOF'","wait-for-it -t 120 \\$DB_HOST:\\$DB_PORT;","wait-for-it -t 120 \\$REDIS_CACHE;","wait-for-it -t 120 \\$REDIS_SOCKETIO;","wait-for-it -t 120 \\$REDIS_QUEUE;","echo \"\\$(ls -1 sites)\";","export start=`date +%s`;","","until [[ -n `grep -hs ^ sites/common_site_config.json | jq -r \".db_host // empty\"` ]] && \\","  [[ -n `grep -hs ^ sites/common_site_config.json | jq -r \".redis_cache // empty\"` ]] && \\","  [[ -n `grep -hs ^ sites/common_site_config.json | jq -r \".redis_queue // empty\"` ]];","do","  echo \"Waiting for sites/common_site_config.json to be created\";","  sleep 5;","  if (( `date +%s`-start > 120 )); then","    echo \"could not find sites/common_site_config.json with required keys\";","    exit 1","  fi","done;","","echo \"sites/common_site_config.json found\";","if [ ! -d \"sites/\\$SITE\" ]; then","  echo \"Ready to create \\$SITE\";","  bench new-site --no-mariadb-socket --db-root-username=\\$DB_ROOT_USER --db-root-password=\\$DB_ROOT_PASSWORD --admin-password=\\$ADMINISTRATOR_PASSWORD --install-app erpnext --set-default \\$SITE --force;","  bench add-system-manager --email=\\$USER_EMAIL --password=\\$USER_PASSWORD;","  bench scheduler enable;","  echo \"New site \\\\$SITE created successfully!\";","else","  echo \"Site \\\\$SITE already exists. Skipping creation.\";","fi;","exit 0;","EOF","# Make the script executable","RUN chmod a+x startup.sh","CMD [\"startup.sh\"]"]},"platform":"linux/amd64","depends_on":{"configurator":{"condition":"service_completed_successfully"}},"volumes":["$$cap_appname-sites:/home/frappe/frappe-bench/sites","$$cap_appname-logs:/home/frappe/frappe-bench/logs"],"environment":{"DB_HOST":"$$cap_DB_HOST","DB_PORT":"$$cap_DB_PORT","DB_ROOT_USER":"$$cap_DB_ROOT_USER","DB_ROOT_PASSWORD":"$$cap_DB_ROOT_PASSWORD","REDIS_CACHE":"srv-captain--$$cap_appname-redis-cache:6379","REDIS_QUEUE":"srv-captain--$$cap_appname-redis-queue:6379","REDIS_SOCKETIO":"srv-captain--$$cap_appname-redis-queue:6379","ADMINISTRATOR_PASSWORD":"$$cap_ADMINISTRATOR_PASSWORD","SITE":"$$cap_appname.$$cap_root_domain","USER_EMAIL":"$$cap_USER_EMAIL","USER_PASSWORD":"$$cap_USER_PASSWORD"}}},"volumes":{"$$cap_appname-db-data":null,"$$cap_appname-sites":null,"$$cap_appname-logs":null,"$$cap_appname-redis-queue-data":null,"$$cap_appname-redis-cache-data":null}}
